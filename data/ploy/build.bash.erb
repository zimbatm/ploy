#!/bin/bash

set -e

BUILD_DIR="<%= build_dir %>"
BARE_REPO="<%= source_dir %>"
COMMIT_ID="<%= commit_id %>"
BUILD_ID="<%= build_id %>"

cd $BUILD_DIR

BASE=`cat ../last_build || echo ubuntu:precise`

banner() {
  echo "=========| $@ |========="
}

indent() {
  sed -e 's/^/# /'
}

commit() {
  docker wait $ID >/dev/null
  local ID=$(docker commit $1); echo $ID > ../last_build; echo $ID
}

rm -rf source
git clone "$BARE_REPO" source
cd source
git checkout -b ploy-build $COMMIT_ID
cd ..

banner pull
docker pull $BASE

banner prepare
ID=$(docker run "$BASE" /bin/sh -c "rm -rf /build && mkdir -p /cache /build && tar -x -C /build")
ID=$(commit $ID)

banner copy source $COMMIT_ID
# TODO: Make a git checkout instead
# TODO: Use the mount option
ID=$(git --git-dir source/.git archive $COMMIT_ID | docker run -i -a stdin "$BASE" /bin/sh -c "mkdir -p /cache /build && tar -x -C /build")
ID=$(commit $ID)

banner build $ID
ID=$(docker run -d $ID /bin/sh -c "/build/script/slugify /cache /app/deploy")
docker attach $ID | indent
ID=$(commit $ID)

banner export $ID
ID=$(docker run -d $ID -i -a stdout /bin/sh -c "cd /app/deploy && tar czf - ." > $BUILD_ID.tar.gz)

md5sum $BUILD_ID.tar.gz > $BUILD_ID.tar.gz.md5sum

